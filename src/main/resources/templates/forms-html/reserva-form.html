<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="~{fragments/head :: head ('Gesti√≥n Reserva')}"></head>

<body class="d-flex flex-column h-100 bg-light">

<header th:replace="~{fragments/header :: header}"></header>

<main class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0 card-title fw-bold">
                        <span th:if="${reserva.id == null}">üìù Nueva Reserva</span>
                        <span th:if="${reserva.id != null}">‚úèÔ∏è Editar Reserva #<span th:text="${reserva.id}"></span></span>
                    </h4>
                </div>
                <div class="card-body p-4">

                    <form th:action="@{${reserva.id == null} ? '/reservas/save' : '/reservas/update'}"
                          th:object="${reserva}" method="post">

                        <input type="hidden" th:field="*{id}">

                        <div th:if="${errorMessage}" class="alert alert-danger shadow-sm">
                            <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${errorMessage}">Error</span>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Cliente (Villano)</label>
                                <select class="form-select" th:field="*{villano}" required>
                                    <option value="">Seleccione un villano...</option>
                                    <option th:each="v : ${allVillanos}" th:value="${v.id}"
                                            th:text="${v.alias} + ' (' + ${v.nombre} + ')'"></option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Guarida a Reservar</label>
                                <select class="form-select" th:field="*{guarida}" id="selectGuarida" required>
                                    <option value="">Seleccione una guarida...</option>
                                    <option th:each="g : ${allGuaridas}" th:value="${g.id}"
                                            th:text="${g.nombre} + ' (' + ${g.precioNoche} + '‚Ç¨/noche)'"></option>
                                </select>
                                <div class="form-text text-muted small">‚ö†Ô∏è Al seleccionar la guarida se cargar√°n sus d√≠as ocupados en rojo.</div>
                            </div>
                        </div>

                        <hr>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha Entrada</label>
                                <input type="text" class="form-control bg-white" th:field="*{fechaInicio}"
                                       id="fechaInicio" placeholder="Selecciona fecha..." required readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha Salida</label>
                                <input type="text" class="form-control bg-white" th:field="*{fechaFin}"
                                       id="fechaFin" placeholder="Selecciona fecha..." required readonly>
                            </div>
                        </div>

                        <div class="mb-4 bg-light p-3 rounded border">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="estadoSwitch" th:field="*{estado}">
                                <label class="form-check-label fw-bold" for="estadoSwitch">Reserva Confirmada (Pago completado)</label>
                            </div>
                        </div>

                        <div class="alert alert-info d-flex align-items-center">
                            <div class="me-3 fs-4">‚ÑπÔ∏è</div>
                            <div>
                                Al guardar, el sistema <strong>calcular√° el coste total</strong> y generar√°/actualizar√° la <strong>factura</strong> autom√°ticamente.
                                <br><small>El m√©todo de pago se define editando la factura posteriormente.</small>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a th:href="@{/reservas}" class="btn btn-secondary me-md-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary px-5">Confirmar Reserva</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Referencias a los elementos del DOM
        const selectGuarida = document.getElementById('selectGuarida');
        const inputInicio = document.getElementById('fechaInicio');
        const inputFin = document.getElementById('fechaFin');

        // 2. Configuraci√≥n base del calendario (Flatpickr)
        const configBase = {
            locale: "es",          // Idioma espa√±ol
            dateFormat: "Y-m-d",   // Formato compatible con Java LocalDate
            minDate: "today",      // No permitir viajar al pasado
            disable: []            // Array vac√≠o inicialmente (se llenar√° con la API)
        };

        // 3. Inicializamos los calendarios en las cajas de texto
        let fpInicio = flatpickr(inputInicio, configBase);
        let fpFin = flatpickr(inputFin, configBase);

        // 4. Funci√≥n para consultar al Backend qu√© d√≠as est√°n ocupados
        function cargarDisponibilidad(guaridaId) {
            if (!guaridaId) return;

            // Bloquear inputs mientras carga para evitar errores
            inputInicio.disabled = true;
            inputFin.disabled = true;

            // Llamada AJAX a nuestro Controller
            fetch(`/api/reservas/ocupadas/${guaridaId}`)
                .then(response => response.json()) // Convertir respuesta a JSON
                .then(fechasOcupadas => {
                    console.log("D√≠as ocupados recibidos del servidor:", fechasOcupadas);

                    // Actualizar la configuraci√≥n de 'disable' en ambos calendarios
                    fpInicio.set('disable', fechasOcupadas);
                    fpFin.set('disable', fechasOcupadas);

                    // Desbloquear inputs
                    inputInicio.disabled = false;
                    inputFin.disabled = false;
                })
                .catch(err => {
                    console.error("Error al cargar disponibilidad:", err);
                    alert("‚ö†Ô∏è Error de conexi√≥n: No se pudo comprobar la disponibilidad.");
                });
        }

        // 5. Evento: Cuando el usuario cambia la Guarida en el desplegable
        selectGuarida.addEventListener('change', function() {
            // this.value contiene el ID num√©rico gracias a th:value="${g.id}"
            cargarDisponibilidad(this.value);

            // Limpiar las fechas seleccionadas anteriormente porque podr√≠an estar ocupadas en la nueva guarida
            fpInicio.clear();
            fpFin.clear();
        });

        // 6. Carga Inicial (Para cuando entramos en modo "Editar")
        // Si el select ya tiene un valor seleccionado, cargamos el calendario inmediatamente
        if (selectGuarida.value) {
            cargarDisponibilidad(selectGuarida.value);
        } else {
            // Si es nueva, desactivar fechas hasta que elija guarida
            inputInicio.disabled = true;
            inputFin.disabled = true;
        }
    });
</script>

</body>
</html>